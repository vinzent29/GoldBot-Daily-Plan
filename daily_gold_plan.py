import os
import feedparser
import requests
import google.generativeai as genai
from datetime import datetime
import pytz

# ================= üîê ‡∏î‡∏∂‡∏á Key ‡∏à‡∏≤‡∏Å GitHub Secrets =================
TELEGRAM_TOKEN = os.environ.get("TELEGRAM_TOKEN")
CHAT_ID = os.environ.get("CHAT_ID")
GEMINI_API_KEY = os.environ.get("GEMINI_API_KEY")

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ AI (‡πÉ‡∏ä‡πâ‡∏£‡∏∏‡πà‡∏ô 1.5 Flash ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡πÅ‡∏•‡∏∞‡∏ü‡∏£‡∏µ)
try:
    if GEMINI_API_KEY:
        genai.configure(api_key=GEMINI_API_KEY)
        model = genai.GenerativeModel('gemini-1.5-flash')
except:
    pass

def send_telegram(message):
    url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
    payload = {'chat_id': CHAT_ID, 'text': message, 'parse_mode': 'HTML'}
    try:
        requests.post(url, json=payload)
    except Exception as e:
        print(f"‚ùå Error sending msg: {e}")

# üåü ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô (Hawk Eye: ‡∏Å‡∏ß‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö ‡πÑ‡∏°‡πà‡∏™‡∏ô‡∏™‡∏µ)
def get_forex_calendar():
    # ‡πÉ‡∏ä‡πâ Feed ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
    url = "https://nfs.faireconomy.media/ff_calendar_thisweek.xml" 
    feed = feedparser.parse(url)
    
    events = []
    
    # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    thai_tz = pytz.timezone('Asia/Bangkok')
    now_thai = datetime.now(thai_tz)
    today_str = now_thai.strftime("%Y-%m-%d")

    print(f"üìÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: {today_str}")

    for entry in feed.entries:
        # 1. ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏π‡πà‡πÄ‡∏á‡∏¥‡∏ô USD (‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ó‡∏≠‡∏á)
        country = entry.get('country', '')
        if 'USD' not in country:
            continue

        # 2. ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ"
        event_date = entry.get('date', '')
        if not event_date.startswith(today_str):
            continue

        # 3. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏Å‡πá‡∏ö‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤ Impact ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô Low/Medium/High)
        title = entry.title
        time_str = entry.get('time', '') # ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô Server time
        impact = entry.get('impact', 'Low')
        
        # ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡πâ AI ‡∏≠‡πà‡∏≤‡∏ô
        events.append(f"- ‡πÄ‡∏ß‡∏•‡∏≤ {time_str} | ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á: {impact} | ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå: {title}")

    if not events:
        return "‡πÑ‡∏°‡πà‡∏°‡∏µ Event USD ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ"
    
    return "\n".join(events)

def analyze_plan():
    print("‚òÄÔ∏è Daily Plan (Hawk Eye) ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...")
    
    calendar_data = get_forex_calendar()
    print(f"üîç ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ AI:\n{calendar_data}")

    # Prompt ‡∏™‡∏±‡πà‡∏á AI (‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ + ‡∏õ‡∏¥‡∏î EA)
    prompt = f"""
    Context:
    ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: {datetime.now(pytz.timezone('Asia/Bangkok')).strftime('%d/%m/%Y')}
    
    ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à (USD Events) ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:
    {calendar_data}

    Task:
    ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÄ‡∏ó‡∏£‡∏î‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥ (XAUUSD) ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å‡∏Ñ‡∏∑‡∏≠ "‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏†‡∏±‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î EA ‡∏´‡∏ô‡∏µ‡∏Ç‡πà‡∏≤‡∏ß"

    Instructions:
    1. **‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á:** ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Event ‡∏ó‡∏µ‡πà "‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö" ‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥ (‡πÄ‡∏ä‡πà‡∏ô CPI, PPI, Fed, Jobless Claims, GDP) 
       - *‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ß‡πà‡∏≤ Low ‡∏´‡∏£‡∏∑‡∏≠ Medium ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏¥‡∏î‡∏ß‡πà‡∏≤‡∏°‡∏±‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏¥‡∏ö‡∏°‡∏≤‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô*
    2. **‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤:** ‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ Server ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏õ‡πá‡∏ô **"‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì"** (‡πÄ‡∏ä‡πà‡∏ô +7 ‡∏ä‡∏°. ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
    3. **‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô:** ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ß‡πà‡∏≤‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô (üî¥ High / üü° Medium)
    4. **Action:** ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á **"‡∏õ‡∏¥‡∏î EA"** ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ó‡∏£‡∏î (No-Trade Zone)

    Output Format (HTML Telegram):
    üõ°Ô∏è <b>Daily Plan: ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏ö‡∏Ç‡πà‡∏≤‡∏ß ({datetime.now(pytz.timezone('Asia/Bangkok')).strftime('%d/%m/%Y')})</b>
    ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ
    
    üö® <b>Event ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</b>
    
    üïí <b>[‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢]</b> : <b>[‡∏ä‡∏∑‡πà‡∏≠ Event]</b>
    üî• ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á: [High/Medium]
    ‚õî <b>‡∏ä‡πà‡∏ß‡∏á‡∏õ‡∏¥‡∏î EA:</b> [‡πÄ‡∏ä‡πà‡∏ô 19:00 - 21:00]
    üìâ ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö: [‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏ß‡∏¥‡∏á‡πÅ‡∏£‡∏á]

    (‡πÑ‡∏•‡πà‡∏•‡∏á‡∏°‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç / ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡πÅ‡∏£‡∏á‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤ "‚úÖ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏≤‡∏á‡∏™‡∏∞‡∏î‡∏ß‡∏Å ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡πÅ‡∏£‡∏á")
    
    ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ
    üß† <b>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢:</b>
    [‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏ó‡∏£‡∏î‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏£‡∏ô‡∏±‡πà‡∏á‡∏ó‡∏±‡∏ö‡∏°‡∏∑‡∏≠]
    """
    
    try:
        response = model.generate_content(prompt)
        ai_plan = response.text
        
        send_telegram(ai_plan)
        print("‚úÖ ‡∏™‡πà‡∏á‡πÅ‡∏ú‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢")
        
    except Exception as e:
        print(f"‚ùå AI Error: {e}")

if __name__ == "__main__":
    if TELEGRAM_TOKEN:
        analyze_plan()
    else:
        print("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Key")
